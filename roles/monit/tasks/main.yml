---

- name: install packages
  apt:
    name:
      - monit
      - curl

- name: install notification script
  template: src=notify_telegram.sh.j2 dest=/usr/local/bin/notify_telegram.sh mode=0755

- name: enable service
  service: name=monit state=started enabled=yes

- name: copy monit confs
  template: src={{item}}.monit.j2 dest=/etc/monit/conf-available/{{item}}
  with_items:
    - networking
    - disk
  notify: reload_monit

- name: enable netowrking monitoring
  file:
    src:   /etc/monit/conf-available/{{item}}
    dest:  /etc/monit/conf-enabled/{{item}}
    state: link
  with_items:
    - networking
    - disk
  notify: reload_monit

- name: copy deamon defaults
  copy: src=daemon-default dest=/etc/monit/conf.d/daemon-default
  notify: reload_monit

- name: make sure conf.d dir is loaded
  lineinfile:
    dest: /etc/monit/monitrc
    regexp: '^#?\s*include\s/etc/monit/conf.d/\*$'
    line: include /etc/monit/conf.d/*
  notify: reload_monit

- name: make sure conf-enabled is loaded
  lineinfile:
    dest: /etc/monit/monitrc
    regexp: '^#?\s*include\s/etc/monit/conf-enabled/\*$'
    line: include /etc/monit/conf-enabled/*
  notify: reload_monit
